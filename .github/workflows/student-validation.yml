name: Student Progress Tracker

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # Detect if this is a student fork or the main repository
  detect-environment:
    name: Detect Environment
    runs-on: ubuntu-latest
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check if fork
        id: check
        run: |
          if [ "${{ github.repository }}" != "AlyxPink/go-training" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "âœ… Running on student fork: ${{ github.repository }}"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Running on main repository - skipping student validation"
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.is_fork == 'true'

      - name: Generate exercise matrix
        if: steps.check.outputs.is_fork == 'true'
        id: set-matrix
        run: |
          exercises=$(find . -name "go.mod" -path "*/[0-9]*" | sed 's|/go.mod||' | sed 's|^./||' | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=$exercises" >> $GITHUB_OUTPUT
          echo "Found exercises: $exercises"

  # Test student implementations
  test-student-code:
    name: "Test: ${{ matrix.exercise }}"
    needs: detect-environment
    if: needs.detect-environment.outputs.is_fork == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        exercise: ${{ fromJson(needs.detect-environment.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Check exercise structure
        working-directory: ${{ matrix.exercise }}
        run: |
          if [ ! -f "go.mod" ]; then
            echo "âŒ No go.mod found"
            exit 1
          fi

          if [ ! -f "main.go" ]; then
            echo "âŒ No main.go found"
            exit 1
          fi

          if [ ! -f "main_test.go" ]; then
            echo "âŒ No main_test.go found"
            exit 1
          fi

          echo "âœ… Exercise structure valid"

      - name: Download dependencies
        working-directory: ${{ matrix.exercise }}
        run: |
          go mod download
          go mod verify

      - name: Run gofmt check
        id: fmt
        working-directory: ${{ matrix.exercise }}
        run: |
          unformatted=$(gofmt -l main.go)
          if [ -n "$unformatted" ]; then
            echo "âŒ Code is not properly formatted"
            echo "Run: gofmt -w main.go"
            gofmt -d main.go
            exit 1
          fi
          echo "âœ… Code is properly formatted"

      - name: Run go vet
        id: vet
        working-directory: ${{ matrix.exercise }}
        run: |
          if go vet ./...; then
            echo "âœ… No vet warnings"
          else
            echo "âŒ Vet found issues"
            exit 1
          fi

      - name: Run tests
        id: test
        working-directory: ${{ matrix.exercise }}
        run: |
          echo "ðŸ§ª Testing student implementation..."
          if go test -v -cover ./...; then
            echo "âœ… All tests passed!"
            echo "status=pass" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed - keep working on this exercise!"
            echo "status=fail" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run race detector (concurrency exercises)
        if: contains(matrix.exercise, 'concurrency')
        working-directory: ${{ matrix.exercise }}
        run: |
          echo "ðŸ Running race detector..."
          if go test -race -short -v ./...; then
            echo "âœ… No race conditions detected"
          else
            echo "âŒ Race conditions found"
            exit 1
          fi

  # Run golangci-lint on all student code
  quality-checks:
    name: Code Quality Checks
    needs: detect-environment
    if: needs.detect-environment.outputs.is_fork == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run golangci-lint
        run: |
          for exercise in $(find . -name "go.mod" -path "*/[0-9]*" | sed 's|/go.mod||' | sed 's|^./||'); do
            echo "ðŸ” Linting $exercise..."
            cd "$exercise"

            if golangci-lint run --config ../.golangci.yml main.go; then
              echo "âœ… $exercise: No lint issues"
            else
              echo "âš ï¸  $exercise: Lint issues found"
            fi

            cd - > /dev/null
          done

  # Track progress and generate summary
  track-progress:
    name: Progress Tracker
    needs: [detect-environment, test-student-code]
    if: |
      always() &&
      needs.detect-environment.outputs.is_fork == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate progress
        id: progress
        run: |
          total=$(find . -name "go.mod" -path "*/[0-9]*" | wc -l)
          echo "total=$total" >> $GITHUB_OUTPUT

          # This is a simplified version - actual passing count would come from test results
          # For now, we'll create a placeholder that students can see
          echo "Total exercises: $total"

      - name: Generate progress badge
        run: |
          mkdir -p .github/badges

          # Create SVG badge (placeholder - would be generated based on actual results)
          cat > .github/badges/progress.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" width="140" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <mask id="a">
              <rect width="140" height="20" rx="3" fill="#fff"/>
            </mask>
            <g mask="url(#a)">
              <path fill="#555" d="M0 0h70v20H0z"/>
              <path fill="#007ec6" d="M70 0h70v20H70z"/>
              <path fill="url(#b)" d="M0 0h140v20H0z"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="35" y="15" fill="#010101" fill-opacity=".3">Progress</text>
              <text x="35" y="14">Progress</text>
              <text x="105" y="15" fill="#010101" fill-opacity=".3">0/65</text>
              <text x="105" y="14">0/65</text>
            </g>
          </svg>
          EOF

      - name: Create completion matrix
        run: |
          cat > PROGRESS.md << 'EOF'
          # My Go Training Progress

          Track your progress through the 65 Go exercises!

          ## Progress Overview

          - **Completed**: 0/65 (0%)
          - **In Progress**: Check failing tests below
          - **Not Started**: All exercises

          ## Exercise Completion Status

          ### Basics (0/15)

          | Exercise | Status | Notes |
          |----------|--------|-------|
          | 01-string-manipulation | âŒ | Not started |
          | 02-number-operations | âŒ | Not started |
          | 03-arrays-slices | âŒ | Not started |
          | 04-maps | âŒ | Not started |
          | 05-functions | âŒ | Not started |
          | 06-pointers | âŒ | Not started |
          | 07-structs | âŒ | Not started |
          | 08-methods | âŒ | Not started |
          | 09-control-flow | âŒ | Not started |
          | 10-loops | âŒ | Not started |
          | 11-constants-enums | âŒ | Not started |
          | 12-type-conversion | âŒ | Not started |
          | 13-json-handling | âŒ | Not started |
          | 14-file-io | âŒ | Not started |
          | 15-command-line-args | âŒ | Not started |

          ### Intermediate (0/15)

          | Exercise | Status | Notes |
          |----------|--------|-------|
          | 01-interfaces | âŒ | Not started |
          | 02-errors | âŒ | Not started |
          | 03-defer-panic-recover | âŒ | Not started |
          | 04-variadic-functions | âŒ | Not started |
          | 05-closures | âŒ | Not started |
          | 06-recursion | âŒ | Not started |
          | 07-type-assertions | âŒ | Not started |
          | 08-string-formatting | âŒ | Not started |
          | 09-testing | âŒ | Not started |
          | 10-benchmarking | âŒ | Not started |
          | 11-generics-basics | âŒ | Not started |
          | 12-packages | âœ… | Teaching exercise |
          | 13-sorting | âŒ | Not started |
          | 14-custom-sort | âŒ | Not started |
          | 15-http-server | âœ… | Teaching exercise |

          ### Concurrency (0/15)

          | Exercise | Status | Notes |
          |----------|--------|-------|
          | 01-goroutines | âŒ | Not started |
          | 02-channels | âŒ | Not started |
          | 03-buffered-channels | âŒ | Not started |
          | 04-channel-select | âŒ | Not started |
          | 05-worker-pools | âŒ | Not started |
          | 06-waitgroups | âŒ | Not started |
          | 07-mutexes | âŒ | Not started |
          | 08-race-detector | âŒ | Not started |
          | 09-atomic | âŒ | Not started |
          | 10-producer-consumer | âŒ | Not started |
          | 11-concurrent-cache | âŒ | Not started |
          | 12-task-scheduler | âŒ | Not started |
          | 13-context | âŒ | Not started |
          | 14-parallel-processing | âŒ | Not started |
          | 15-sync-primitives | âŒ | Not started |

          ### Advanced (0/15)

          | Exercise | Status | Notes |
          |----------|--------|-------|
          | 01-custom-errors | âŒ | Not started |
          | 02-empty-interface | âŒ | Not started |
          | 03-type-embedding | âŒ | Not started |
          | 04-reflection | âŒ | Not started |
          | 05-generics-advanced | âŒ | Not started |
          | 06-build-tags | âŒ | Not started |
          | 07-database-access | âœ… | Teaching exercise |
          | 08-middleware | âŒ | Not started |
          | 09-websockets | âŒ | Not started |
          | 10-grpc-basics | âŒ | Not started |
          | 11-testing-advanced | âŒ | Not started |
          | 12-code-generation | âŒ | Not started |
          | 13-ast-manipulation | âŒ | Not started |
          | 14-cgo-basics | âŒ | Not started |
          | 15-performance-optimization | âŒ | Not started |

          ### Projects (0/5)

          | Exercise | Status | Notes |
          |----------|--------|-------|
          | 01-cli-tool | âŒ | Not started |
          | 02-rest-api | âŒ | Not started |
          | 03-web-scraper | âŒ | Not started |
          | 04-key-value-store | âŒ | Not started |
          | 05-distributed-task-queue | âŒ | Not started |

          ---

          **Note**: This file is auto-generated. Update status by pushing code that passes tests!

          **Legend**:
          - âœ… Complete (all tests pass)
          - ðŸŸ¡ In Progress (some tests pass)
          - âŒ Not Started (tests fail)
          - ðŸ“š Teaching Exercise (complete implementation provided)
          EOF

      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ¯ Go Training Progress

          ### Summary
          - **Total Exercises**: 65
          - **Completed**: Check individual exercise results above
          - **Note**: This is your first run! All exercises will show as failing until you implement solutions.

          ### Next Steps
          1. Pick an exercise to work on (start with `basics/01-string-manipulation`)
          2. Read the README.md in the exercise directory
          3. Implement the solution in `main.go`
          4. Run `go test -v` locally to check your work
          5. Push your code to see it turn green in CI!

          ### Getting Help
          - Check `HINTS.md` in each exercise for guidance
          - Look at test cases in `main_test.go` to understand requirements
          - Teaching exercises (intermediate/12, 15, advanced/07) have complete implementations to learn from

          ### Quality Checks
          Your code is automatically checked for:
          - âœ… Tests passing
          - âœ… Proper formatting (gofmt)
          - âœ… No vet warnings
          - âœ… Code quality (golangci-lint)
          - âœ… Race conditions (concurrency exercises)

          Keep going! ðŸš€
          EOF

  # Summary job that always runs
  summary:
    name: Validation Summary
    needs: [detect-environment, test-student-code, quality-checks, track-progress]
    if: always() && needs.detect-environment.outputs.is_fork == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "## Student Validation Complete"
          echo ""
          echo "Check individual exercise results above for details."
          echo "Keep working on failing exercises - you've got this! ðŸ’ª"
